#!/usr/bin/ruby
# ReFS 0x4000 Cluster Extractor
# By mmorsi - 2014-07-14

CLUSTERS = [0x1e, 0x20, 0x21, 0x22, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
            0x2c0, 0x2c1, 0x2c2, 0x2c3, 0x2c4, 0x2c5, 0x2c6, 0x2c7, 0x2c8, 0x2cc, 0x2cd, 0x2ce, 0x2cf]

DISK   = 'flat-disk.vmdk'
OUTDIR = 'clusters'

REFS_VOLUME_OFFSET = 0x2100000

inf  = File.open(DISK, 'rb')
CLUSTERS.each do |cluster|
  outf = File.open("#{OUTDIR}/#{cluster.to_s(16)}", 'wb')

  offset = REFS_VOLUME_OFFSET + cluster * 0x4000
  inf.seek(offset)
  contents = inf.read(0x4000)
  outf.write contents
  outf.close
end

inf.close
